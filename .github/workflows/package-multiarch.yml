name: Package Multi-arch Runtimes and Installers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  OUT_DIR: target/generated_builds

jobs:
  build-runtimes:
    name: Build runtime images (multi-arch)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up QEMU for multi-arch
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build runtime inside container (per-arch)
        env:
          PLATFORM: linux/${{ matrix.arch }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p ${{ env.OUT_DIR }}
          chmod +x scripts/ci/build_runtime_in_container.sh || true
          docker run --rm --platform=${{ env.PLATFORM }} \
            -v "${{ github.workspace }}:/work" -w /work \
            eclipse-temurin:17-jdk bash -c "./scripts/ci/build_runtime_in_container.sh ${{ env.ARCH }}"

      - name: Upload runtime artifact
        uses: actions/upload-artifact@v3
        with:
          name: runtime-${{ matrix.arch }}
          path: ${{ env.OUT_DIR }}/runtime-${{ matrix.arch }}.zip

  package-linux:
    name: Package Linux installers (per-arch)
    needs: build-runtimes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download runtime artifact
        uses: actions/download-artifact@v2
        with:
          name: runtime-${{ matrix.arch }}
          path: ${{ env.OUT_DIR }}

      - name: Run packaging inside container (per-arch)
        run: |
          chmod +x scripts/generate-deb.sh || true
          chmod +x scripts/generate-rpm.sh || true
          chmod +x scripts/generate-appimage.sh || true
          chmod +x scripts/generate-snap.sh || true
          docker run --rm --platform=linux/${{ matrix.arch }} \
            -v "${{ github.workspace }}:/work" -w /work \
            eclipse-temurin:17-jdk bash -c "./scripts/generate-deb.sh || true && ./scripts/generate-rpm.sh || true && ./scripts/generate-appimage.sh || true && ./scripts/generate-snap.sh || true"

      - name: List generated files
        run: |
          echo "Generated files in ${{ env.OUT_DIR }}:"
          ls -la ${{ env.OUT_DIR }} || true

      - name: Upload Debian packages (per-arch)
        uses: actions/upload-artifact@v3
        with:
          name: installers-deb-${{ matrix.arch }}
          path: |
            ${{ env.OUT_DIR }}/**/*.deb
            ${{ env.OUT_DIR }}/*.deb

      - name: Upload RPM packages (per-arch)
        uses: actions/upload-artifact@v3
        with:
          name: installers-rpm-${{ matrix.arch }}
          path: |
            ${{ env.OUT_DIR }}/**/*.rpm
            ${{ env.OUT_DIR }}/*.rpm

      - name: Upload AppImage files (per-arch)
        uses: actions/upload-artifact@v3
        with:
          name: installers-appimage-${{ matrix.arch }}
          path: |
            ${{ env.OUT_DIR }}/**/*.AppImage
            ${{ env.OUT_DIR }}/*.AppImage

      - name: Upload Snap packages (per-arch)
        uses: actions/upload-artifact@v3
        with:
          name: installers-snap-${{ matrix.arch }}
          path: |
            ${{ env.OUT_DIR }}/**/*.snap
            ${{ env.OUT_DIR }}/*.snap

  package-windows-x64:
    name: Package Windows MSI (x64)
    needs: build-runtimes
    runs-on: windows-2022
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download x64 runtime artifact
        uses: actions/download-artifact@v2
        with:
          name: runtime-amd64
          path: ${{ env.OUT_DIR }}

      - name: Note about MSIs
        run: |
          Write-Host "This job demonstrates using a runtime image for packaging on Windows runners."
          Write-Host "Producing MSI installers on Windows requires WiX Toolset and is best run on native Windows toolchains."

      - name: Run MSI packaging script (if present)
        if: always()
        shell: powershell
        run: |
          if (Test-Path scripts/generate-msi.ps1) {
            Write-Host 'Invoking scripts/generate-msi.ps1'
            pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/generate-msi.ps1 -RuntimeImageX64 "${{ env.OUT_DIR }}/runtime-amd64" -RuntimeImageArm64 "${{ env.OUT_DIR }}/runtime-arm64" || Write-Host 'MSI script finished or failed'
          } else {
            Write-Host 'No MSI script to run'
          }

      - name: List generated files
        shell: powershell
        run: |
          Write-Host 'Generated files in target/generated_builds:'
          Get-ChildItem -Path target\generated_builds -Recurse -Force || Write-Host 'No files found'

      - name: Upload Windows installers
        uses: actions/upload-artifact@v3
        with:
          name: installers-windows-x64
          path: |
            ${{ env.OUT_DIR }}/*.msi
            ${{ env.OUT_DIR }}/**/*.msi

  sign-and-release:
    name: Sign artifacts and create GitHub Release
    needs: [package-linux, package-windows-x64]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create output dir
        run: mkdir -p release_files

      - name: Download per-target artifacts (amd64/arm64)
        uses: actions/download-artifact@v2
        with:
          name: installers-deb-amd64
          path: release_files
        continue-on-error: true

      - name: Download installers-deb-arm64
        uses: actions/download-artifact@v2
        with:
          name: installers-deb-arm64
          path: release_files
        continue-on-error: true

      - name: Download installers-rpm-amd64
        uses: actions/download-artifact@v2
        with:
          name: installers-rpm-amd64
          path: release_files
        continue-on-error: true

      - name: Download installers-rpm-arm64
        uses: actions/download-artifact@v2
        with:
          name: installers-rpm-arm64
          path: release_files
        continue-on-error: true

      - name: Download installers-appimage-amd64
        uses: actions/download-artifact@v2
        with:
          name: installers-appimage-amd64
          path: release_files
        continue-on-error: true

      - name: Download installers-appimage-arm64
        uses: actions/download-artifact@v2
        with:
          name: installers-appimage-arm64
          path: release_files
        continue-on-error: true

      - name: Download installers-snap-amd64
        uses: actions/download-artifact@v2
        with:
          name: installers-snap-amd64
          path: release_files
        continue-on-error: true

      - name: Download installers-snap-arm64
        uses: actions/download-artifact@v2
        with:
          name: installers-snap-arm64
          path: release_files
        continue-on-error: true

      - name: Download Windows installers
        uses: actions/download-artifact@v2
        with:
          name: installers-windows-x64
          path: release_files
        continue-on-error: true

      - name: List release files
        run: ls -la release_files || true

      - name: Import GPG key (if provided)
        if: ${{ secrets.GPG_PRIVATE_KEY }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import || true

      - name: Sign release files with GPG (if key provided)
        if: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          for f in release_files/*; do
            if [ -f "$f" ]; then
              gpg --batch --yes --armor --detach-sign -o "$f.asc" "$f" || true
            fi
          done

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: artifacts-${{ github.run_number }}
          release_name: Automated artifacts #${{ github.run_number }}
          body: "Automated build artifacts produced by CI"
          draft: false
          prerelease: false

      - name: Upload each release asset individually
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.create_release.outputs.upload_url }}
        run: |
          set -e
          # strip the templated part '{?name,label}' from the upload_url
          base_url="${UPLOAD_URL%{*}"
          echo "Uploading files from release_files to $base_url"
          for f in release_files/*; do
            if [ -f "$f" ]; then
              name=$(basename "$f")
              echo "Uploading $name"
              curl -s -X POST \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$f" "${base_url}?name=${name}"
            fi
          done


# Notes:
# - This workflow is an example template demonstrating per-arch runtime builds using Docker+QEMU
#   and simple packaging steps. You will likely need to customize the container image, jlink
#   invocation, and packaging scripts to match your project's modules and packaging requirements.
# - Building Windows ARM MSIs in CI is typically harder because the WiX Toolset and proper
#   Windows-arm64 environment are required. Consider running a Windows-arm64 self-hosted runner
#   or performing cross-builds on appropriate infrastructure if needed.
